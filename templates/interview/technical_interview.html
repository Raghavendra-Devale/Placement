<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Interview Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .question-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .question-card:hover {
            transform: scale(1.05);
        }
        .progress-bar {
            height: 20px;
        }
        .feedback-section {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .loading-message {
            margin-top: 1rem;
            font-size: 1.2rem;
        }
        .processing-status {
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Technical Interview Platform</h1>

        <!-- Question Selection Section -->
        <div id="question-selection" class="mb-5">
            <h3>Select a Question</h3>
            <div class="row" id="questions-container">
                <!-- Questions will be dynamically rendered here -->
            </div>
        </div>

        <!-- Recording Interface Section -->
        <div id="recording-interface" class="mb-5" style="display: none;">
            <h3>Recording Your Answer</h3>
            <p id="selected-question"></p>
            <div class="mb-3">
<<<<<<< HEAD
                <video id="video-preview" width="100%" height="300" autoplay muted></video>
=======
                <div class="text-center p-5 border rounded bg-light">
                    <i class="fas fa-microphone fa-4x"></i>
                    <p class="mt-3">Recording audio only...</p>
                </div>
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
            </div>
            <div class="progress mb-3">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="progress-bar"></div>
            </div>
            <button class="btn btn-danger" onclick="stopRecording()">Stop Recording</button>
            <button class="btn btn-secondary" onclick="replayRecording()">Replay</button>
        </div>

<<<<<<< HEAD
=======
        <!-- Transcription Review Section -->
        <div id="transcription-review" class="mb-5 fade-in" style="display: none;">
            <h3>Review Your Response</h3>
            <div class="card p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>Your Transcribed Answer</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="manual-edit-switch" onchange="toggleManualEdit()">
                        <label class="form-check-label" for="manual-edit-switch">Edit manually</label>
                    </div>
                </div>
                <div id="transcription-container">
                    <div id="transcribed-text" class="p-3 border rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                        Loading transcription...
                    </div>
                    <div id="manual-edit-container" style="display: none;">
                        <textarea id="manual-transcription" class="form-control" rows="8" placeholder="Enter your response here if the automatic transcription failed..."></textarea>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-secondary" onclick="rerecordAnswer()">Record Again</button>
                <button class="btn btn-primary" onclick="submitAnalysis()">Submit for Analysis</button>
            </div>
        </div>

>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
        <!-- Loading Section with Better Feedback -->
        <div id="loading" class="loading-container" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="loading-message">Analyzing your response...</p>
            <div class="progress processing-status">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="analysis-progress" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="status-message" class="mt-2">Initializing analysis...</p>
        </div>

        <!-- AI Review & Feedback Section -->
        <div id="feedback-section" class="feedback-section fade-in">
            <h3>AI Review & Feedback</h3>
            <div class="card p-3 mb-3">
<<<<<<< HEAD
=======
                <h5>Audio Answer</h5>
                <audio id="audio-answer" controls>
                    <source id="audio-source" src="" type="audio/webm">
                    Your browser does not support the audio element.
                </audio>
            </div>
            <div class="card p-3 mb-3">
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                <h5>Content Accuracy</h5>
                <p id="accuracy-feedback">Your answer was 85% accurate.</p>
            </div>
            <div class="card p-3 mb-3">
<<<<<<< HEAD
                <h5>Body Language</h5>
                <p id="body-language-feedback">Your posture was confident, but avoid looking away frequently.</p>
            </div>
            <div class="card p-3 mb-3">
                <h5>Speaking Clarity</h5>
                <p id="clarity-feedback">Your speech was clear, but try to reduce filler words.</p>
=======
                <h5>Key Points Covered</h5>
                <ul id="key-points-list">
                    <li>You explained the core concept clearly</li>
                    <li>You provided relevant technical details</li>
                </ul>
            </div>
            <div class="card p-3 mb-3">
                <h5>Missing Points</h5>
                <ul id="missing-points-list">
                    <li>Consider discussing time/space complexity</li>
                    <li>Mention alternative approaches to the problem</li>
                </ul>
            </div>
            <div class="card p-3 mb-3">
                <h5>Speaking Clarity</h5>
                <p id="clarity-feedback">Your explanation was structured well, with clear technical terminology.</p>
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
            </div>
            <div class="card p-3">
                <h5>Improvement Tips</h5>
                <ul id="improvement-tips">
<<<<<<< HEAD
                    <li>Practice maintaining eye contact with the camera.</li>
=======
                    <li>Use diagrams or visual examples when explaining complex concepts.</li>
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                    <li>Structure your answers more concisely.</li>
                </ul>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary" onclick="backToQuestions()">Try Another Question</button>
            </div>
        </div>
    </div>

    <script>
        let timer;
        let progress = 0;
        let analysisTimer;
        let currentAnalysisId = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        const questions = [
<<<<<<< HEAD
            { id: 1, text: "Explain the concept of closures in JavaScript.", type: "Technical" },
            { id: 2, text: "Write a function to reverse a linked list.", type: "Technical" },
            { id: 3, text: "What are the differences between SQL and NoSQL databases?", type: "Technical" },
            { id: 4, text: "Describe how virtual memory works in operating systems.", type: "Technical" },
            { id: 5, text: "Explain the concept of multithreading and its benefits.", type: "Technical" },
            { id: 6, text: "What is dynamic programming and when would you use it?", type: "Technical" }
=======
            { id: 7, text: "Explain the concept of closures in JavaScript.", type: "Technical" },
            { id: 8, text: "Write a function to reverse a linked list.", type: "Technical" },
            { id: 9, text: "What are the differences between SQL and NoSQL databases?", type: "Technical" },
            { id: 10, text: "Describe how virtual memory works in operating systems.", type: "Technical" },
            { id: 11, text: "Explain the concept of multithreading and its benefits.", type: "Technical" },
            { id: 12, text: "What is dynamic programming and when would you use it?", type: "Technical" }
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
        ];

        function renderQuestions() {
            const questionContainer = document.getElementById('questions-container');
            questionContainer.innerHTML = ''; // Clear existing questions
            
            questions.forEach(question => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                card.innerHTML = `
                    <div class="card question-card p-3" onclick="selectQuestion('${question.text}')">
                        <h5>${question.text}</h5>
                    </div>
                `;
                questionContainer.appendChild(card);
            });
        }

        function selectQuestion(question) {
            document.getElementById('question-selection').style.display = 'none';
            document.getElementById('recording-interface').style.display = 'block';
            document.getElementById('selected-question').innerText = question;
            startRecording();
        }

        function startRecording() {
            progress = 0;
            document.getElementById('progress-bar').style.width = '0%';
            recordedChunks = [];
            
<<<<<<< HEAD
            const video = document.getElementById('video-preview');
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    video.srcObject = stream;
=======
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };
                    mediaRecorder.start();
                })
                .catch(err => console.error('Error accessing media devices.', err));

            timer = setInterval(() => {
                progress += 2;
                document.getElementById('progress-bar').style.width = progress + '%';
                if (progress >= 100) stopRecording();
            }, 1000);
        }

        function stopRecording() {
            clearInterval(timer);
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
<<<<<<< HEAD
                    const video = document.getElementById('video-preview');
                    const stream = video.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    video.srcObject = null;

                    document.getElementById('recording-interface').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';
                    document.getElementById('status-message').textContent = 'Initializing analysis...';
                    
                    startAnalysisProgress();
                    
                    setTimeout(() => {
                        analyzeResponse();
                    }, 500);
=======
                    // Show transcription in progress
                    document.getElementById('transcribed-text').textContent = "Transcribing your response...";
                    document.getElementById('recording-interface').style.display = 'none';
                    document.getElementById('transcription-review').style.display = 'block';
                    
                    // Create blob and transcribe
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    transcribeRecording(blob);
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                };
            }
        }

<<<<<<< HEAD
=======
        function toggleManualEdit() {
            const isManualMode = document.getElementById('manual-edit-switch').checked;
            document.getElementById('transcribed-text').style.display = isManualMode ? 'none' : 'block';
            document.getElementById('manual-edit-container').style.display = isManualMode ? 'block' : 'none';
            
            // If switching to manual mode and transcription failed, clear the placeholder text
            if (isManualMode) {
                const transcribedText = document.getElementById('transcribed-text').textContent.trim();
                if (transcribedText.includes("Could not transcribe") || transcribedText.includes("Error during transcription")) {
                    document.getElementById('manual-transcription').value = '';
                } else if (transcribedText !== "Loading transcription...") {
                    // Copy the transcribed text to the textarea for editing
                    document.getElementById('manual-transcription').value = transcribedText;
                }
            }
        }
        
        function transcribeRecording(blob) {
            // Create form data for transcription request
            const formData = new FormData();
            formData.append('audio', blob, 'audio.webm');
            
            // Send to server for transcription
            fetch('/transcribe_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('transcribed-text').textContent = data.text;
                    document.getElementById('manual-transcription').value = data.text;
                } else {
                    const errorMessage = "Automatic transcription failed. You can manually edit your response or submit as is.";
                    document.getElementById('transcribed-text').textContent = errorMessage;
                    // Automatically switch to manual edit mode on transcription failure
                    document.getElementById('manual-edit-switch').checked = true;
                    toggleManualEdit();
                }
            })
            .catch(error => {
                const errorMessage = "Automatic transcription failed. You can manually edit your response or submit as is.";
                document.getElementById('transcribed-text').textContent = errorMessage;
                // Automatically switch to manual edit mode on transcription failure
                document.getElementById('manual-edit-switch').checked = true;
                toggleManualEdit();
                console.error('Error transcribing:', error);
            });
        }
        
        function rerecordAnswer() {
            document.getElementById('transcription-review').style.display = 'none';
            document.getElementById('recording-interface').style.display = 'block';
            startRecording();
        }
        
        function submitAnalysis() {
            // Check if in manual edit mode and get the text from the appropriate source
            const isManualMode = document.getElementById('manual-edit-switch').checked;
            const transcribedText = isManualMode 
                ? document.getElementById('manual-transcription').value 
                : document.getElementById('transcribed-text').textContent;
            
            // Store the transcribed text to potentially use in analysis
            window.transcribedUserResponse = transcribedText;
            
            document.getElementById('transcription-review').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('status-message').textContent = 'Initializing analysis...';
            
            startAnalysisProgress();
            analyzeResponse();
        }

>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
        function startAnalysisProgress() {
            let analysisProgress = 0;
            const progressBar = document.getElementById('analysis-progress');
            const statusMessage = document.getElementById('status-message');
            const stages = [
                { progress: 20, message: 'Processing speech...' },
                { progress: 40, message: 'Analyzing content accuracy...' },
<<<<<<< HEAD
                { progress: 60, message: 'Evaluating body language...' },
=======
                { progress: 60, message: 'Evaluating speaking patterns...' },
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                { progress: 80, message: 'Assessing speaking clarity...' },
                { progress: 95, message: 'Generating feedback...' }
            ];
            let currentStage = 0;
            
            analysisTimer = setInterval(() => {
                analysisProgress += 1;
                progressBar.style.width = `${analysisProgress}%`;
                
                if (currentStage < stages.length && analysisProgress >= stages[currentStage].progress) {
                    statusMessage.textContent = stages[currentStage].message;
                    currentStage++;
                }
                
                if (analysisProgress >= 100) {
                    clearInterval(analysisTimer);
                }
            }, 80); // Faster progress than before
        }

        function replayRecording() {
            document.getElementById('recording-interface').style.display = 'block';
            document.getElementById('feedback-section').style.display = 'none';
            startRecording(); // Restart recording process
        }

        function analyzeResponse() {
            // Get the current question being answered
            const questionText = document.getElementById('selected-question').innerText;
            const question = questions.find(q => q.text === questionText);
            const questionId = question ? question.id : null;
            
            const formData = new FormData();
            formData.append('question_id', questionId);

            if (recordedChunks.length === 0) {
                document.getElementById('loading').style.display = 'none';
                alert('No recording was made. Please record your answer before submitting.');
                document.getElementById('recording-interface').style.display = 'block';
                return;
            }

<<<<<<< HEAD
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            formData.append('video', blob, 'recording.webm');

            fetch('/analyze', {
=======
            // Create blob with recordedChunks
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            
            // Check file size - if larger than 90MB, compress or alert user
            if (blob.size > 90 * 1024 * 1024) {
                document.getElementById('loading').style.display = 'none';
                alert('Your recording is too large. Please try recording a shorter answer.');
                document.getElementById('recording-interface').style.display = 'block';
                return;
            }
            
            // Add transcription if using manual mode
            const isManualMode = document.getElementById('manual-edit-switch').checked;
            if (isManualMode) {
                const manualText = document.getElementById('manual-transcription').value;
                formData.append('manual_transcription', manualText);
            }
            
            formData.append('audio', blob, 'audio.webm');

            fetch('/analyze_audio', {
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
<<<<<<< HEAD
                    currentAnalysisId = data.analysis_id;
                    pollAnalysisStatus();
                } else {
                    console.error('Error starting analysis:', data.message);
=======
                    // Since the analyze_audio endpoint returns the result directly, we can display it
                    displayAnalysisResults(data.result);
                } else {
                    console.error('Error analyzing response:', data.message);
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                    document.getElementById('loading').style.display = 'none';
                    alert('Error analyzing response: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error analyzing response:', error);
                document.getElementById('loading').style.display = 'none';
            });
        }

<<<<<<< HEAD
        function pollAnalysisStatus() {
            if (!currentAnalysisId) return;
            
            const pollInterval = setInterval(() => {
                fetch(`/check_analysis_status/${currentAnalysisId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const result = data.result;
                        
                        // Update progress display
                        document.getElementById('analysis-progress').style.width = `${result.progress}%`;
                        document.getElementById('status-message').textContent = result.message;
                        
                        // If analysis is complete, display results
                        if (result.status === 'completed') {
                            clearInterval(pollInterval);
                            displayAnalysisResults(result);
                        } else if (result.status === 'error') {
                            clearInterval(pollInterval);
                            // Display error message
                            document.getElementById('loading').style.display = 'none';
                            alert('Error in analysis: ' + result.message);
                        }
                    } else {
                        clearInterval(pollInterval);
                        console.error('Error checking analysis status:', data.message);
                    }
                })
                .catch(error => {
                    clearInterval(pollInterval);
                    console.error('Error polling status:', error);
                });
            }, 1000); // Poll every second
        }

=======
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
        function displayAnalysisResults(result) {
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';
            
            // Display feedback section
            document.getElementById('feedback-section').style.display = 'block';
            
<<<<<<< HEAD
            // Update feedback content with accuracy visualization
            const accuracyElement = document.getElementById('accuracy-feedback');
            const accuracy = result.accuracy;
=======
            // If the result is wrapped in a result property (from the analyze_audio endpoint)
            if (result.result) {
                result = result.result;
            }
            
            // Update feedback content with accuracy visualization
            const accuracyElement = document.getElementById('accuracy-feedback');
            const accuracy = result.accuracy || 75; // Use default if not available
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
            
            // Create a more detailed accuracy display with color coding
            let accuracyColorClass = 'text-danger';
            if (accuracy >= 90) {
                accuracyColorClass = 'text-success';
            } else if (accuracy >= 75) {
                accuracyColorClass = 'text-primary';
            } else if (accuracy >= 60) {
                accuracyColorClass = 'text-warning';
            }
            
            accuracyElement.innerHTML = `
<<<<<<< HEAD
                Your answer was <span class="${accuracyColorClass} fw-bold">${accuracy}%</span> accurate. 
                ${getAccuracyCommentary(accuracy)}
            `;
            
            document.getElementById('body-language-feedback').innerText = result.bodyLanguageFeedback;
            document.getElementById('clarity-feedback').innerText = result.clarityFeedback;
            
            // Update improvement tips if available
            if (result.improvementTips && result.improvementTips.length > 0) {
                const tipsList = document.getElementById('improvement-tips');
                tipsList.innerHTML = '';
=======
                Your answer covered <span class="${accuracyColorClass} fw-bold">${accuracy}%</span> of expected key points. 
                ${getAccuracyCommentary(accuracy)}
            `;
            
            // Update key points covered
            const keyPointsList = document.getElementById('key-points-list');
            keyPointsList.innerHTML = '';
            
            if (result.key_points_covered && result.key_points_covered.length > 0) {
                result.key_points_covered.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    keyPointsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Your technical explanation was structured logically";
                keyPointsList.appendChild(li);
            }
            
            // Update missing points
            const missingPointsList = document.getElementById('missing-points-list');
            missingPointsList.innerHTML = '';
            
            if (result.missing_points && result.missing_points.length > 0) {
                result.missing_points.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    missingPointsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Consider discussing trade-offs of your solution";
                missingPointsList.appendChild(li);
            }
            
            // Update clarity feedback
            document.getElementById('clarity-feedback').innerText = 
                result.clarityFeedback || 
                "Your technical explanation was clear. Focus on maintaining this clarity in actual interviews.";
            
            // Update improvement tips if available
            const tipsList = document.getElementById('improvement-tips');
            tipsList.innerHTML = '';
            
            if (result.improvementTips && result.improvementTips.length > 0) {
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
                result.improvementTips.forEach(tip => {
                    const li = document.createElement('li');
                    li.textContent = tip;
                    tipsList.appendChild(li);
                });
<<<<<<< HEAD
=======
            } else if (result.improvement_areas && result.improvement_areas.length > 0) {
                // Handle format from analyze_audio endpoint
                result.improvement_areas.forEach(area => {
                    const li = document.createElement('li');
                    li.textContent = area;
                    tipsList.appendChild(li);
                });
            } else {
                // Default tips
                const defaultTips = [
                    "Practice explaining complex concepts more concisely",
                    "Include real-world examples to illustrate technical points",
                    "Demonstrate problem-solving approach rather than just the solution"
                ];
                defaultTips.forEach(tip => {
                    const li = document.createElement('li');
                    li.textContent = tip;
                    tipsList.appendChild(li);
                });
>>>>>>> ecfd4dffffe076ca6ba48fffe74e6d4f3d92b9b1
            }
        }
        
        // Generate commentary based on accuracy level
        function getAccuracyCommentary(accuracy) {
            if (accuracy >= 90) {
                return "Your response demonstrates excellent understanding of the topic.";
            } else if (accuracy >= 80) {
                return "Your answer covers most key points of the topic well.";
            } else if (accuracy >= 70) {
                return "Your response addresses the basics but misses some important details.";
            } else if (accuracy >= 60) {
                return "Your answer has some relevant points but shows gaps in understanding.";
            } else {
                return "Your response indicates significant areas for improvement on this topic.";
            }
        }

        function backToQuestions() {
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('question-selection').style.display = 'block';
        }

        // Render questions on page load
        window.onload = renderQuestions;
    </script>
</body>
</html>
